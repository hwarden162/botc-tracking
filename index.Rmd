---
title: "Blood on the Clocktower Stats: Huff"
output: 
  flexdashboard::flex_dashboard:
    df_print: "paged"
    orientation: rows
    vertical_layout: scroll
    theme: lumen
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse) 
library(janitor)
library(googlesheets4)
library(DT)
library(gt)
library(lubridate)
library(tidyquant)

data <- read_sheet("https://docs.google.com/spreadsheets/d/14py4LXl5cANQIrlkxzaFnR3u3PwLRyYVlconhnnLOBk/edit#gid=0") |> 
  clean_names() |> 
  mutate(
    date = as_date(date)
  ) |> 
  mutate(
    script = case_match(
      script,
      "TB" ~ "Trouble Brewing",
      "SNV" ~ "Sects and Violets",
      "BMR" ~ "Bad Moon Rising",
      .default = script
    )
  )

num_games <- data |> 
  filter(result %in% c("Win", "Lose")) |> 
  nrow()

num_wins <- data |> 
  filter(result == "Win") |> 
  nrow()

perc_wins <- (num_wins/num_games)*100

num_good <- sum(data$starting_alignment %in% c("Townsfolk", "Outsider"))

perc_good <- (num_good/num_games)*100

alignments <- c(
  "Demon", 
  "Minion", 
  "Outsider", 
  "Townsfolk"
)

alignment_colours <- c(
  "red", 
  "orange", 
  "cyan", 
  "blue"
)

tb_characters <- c(
  "Washerwoman",
  "Librarian",
  "Investigator",
  "Chef",
  "Empath",
  "Fortune Teller",
  "Undertaker",
  "Monk",
  "Ravenkeeper",
  "Virgin",
  "Slayer",
  "Soldier",
  "Mayor",
  "Butler",
  "Drunk",
  "Recluse",
  "Saint",
  "Poisoner",
  "Spy",
  "Scarlet Woman",
  "Baron",
  "Imp"
)

snv_characters <- c(
  "Clockmaker",
  "Dreamer",
  "Snake Charmer",
  "Mathematician",
  "Flower Girl",
  "Town Cryer",
  "Oracle",
  "Savant",
  "Seamstress",
  "Philosopher",
  "Artist",
  "Juggler",
  "Sage",
  "Mutant",
  "Sweetheart",
  "Barber",
  "Klutz",
  "Evil Twin",
  "Witch",
  "Cerenovus",
  "Pit-Hag",
  "Fang Gu",
  "Vigormortis",
  "No Dashii",
  "Vortox"
)
```

Overview
==========

Row
-----------------------------------------------------------------------

### Number of Blood on the Clocktower Games Played (Since 11/09/2023) 

```{r}
valueBox(num_games)
```

### Overall Win Percentage

```{r}
gauge(
  round(
    perc_wins,
    digits = 2
  ),
  min = 0,
  max = 100,
  gaugeSectors(
    success = c(50, 100),
    warning = c(35, 50),
    danger = c(0, 35)
  ),
  symbol = "%"
)
```

### Overall Good Percentage

```{r}
gauge(
  round(
    perc_good,
    digits = 2
  ),
  min = 0,
  max = 100,
  gaugeSectors(
    success = c(50, 100),
    warning = c(35, 50),
    danger = c(0, 35)
  ),
  symbol = "%"
)
```

Row
-----------------------------------------------------------------------

### Alignment Distribution

```{r}
data |> 
  mutate(
    starting_alignment = factor(starting_alignment, levels = alignments)
  ) |> 
  group_by(starting_alignment) |> 
  summarise(
    count = n()
  ) |> 
  ggplot() +
  aes(
    x = starting_alignment,
    y = count,
    fill = starting_alignment
  ) +
  geom_col(
    width = 0.6
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Starting Alignment",
    y = "Number of Games"
  ) +
  scale_fill_manual(
    drop = FALSE,
    values = alignment_colours
  ) +
  guides(
    fill = "none"
  ) +
  scale_x_discrete(
    drop = FALSE
  )

```

### Alignment Win Rate

```{r}
data |> 
  mutate(
    starting_alignment = factor(starting_alignment, levels = alignments)
  ) |> 
  filter(result %in% c("Win", "Lose")) |> 
  group_by(starting_alignment, result) |> 
  summarise(
    count = n()
  ) |> 
  ungroup() |> 
  group_by(starting_alignment) |> 
  pivot_wider(
    id_cols = starting_alignment,
    names_from = result,
    values_from = count
  ) %>%
  mutate(
    Lose = replace(Lose, is.na(Lose), 0),
    Win = replace(Win, is.na(Win), 0),
    win_perc = (Win / (Win + Lose)) * 100
  ) |> 
  ggplot() +
  aes(
    x = starting_alignment,
    y = win_perc,
    fill = starting_alignment
  ) +
  geom_col(
    width = 0.6
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Starting Alignment",
    y = "Win Percentage"
  ) +
  ylim(c(0, 100)) +
  scale_fill_manual(
    drop = FALSE,
    values = alignment_colours,
  ) +
  guides(
    fill = "none"
  ) +
  scale_x_discrete(
    drop = FALSE
  )
```

Row
-----------------------------------------------------------------------

### Win Rate Over Time

```{r}
data |> 
  group_by(date) |> 
  summarise(
    win_rate = sum(result == "Win")/n()
  ) |> 
  ggplot() +
  aes(
    x = date,
    y = win_rate
  ) +
  geom_line(
    alpha = 0.3
  ) +
  geom_ma(
    ma_fun = SMA,
    n = 3
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(),
    limits = c(0, 1)
  ) +
  labs(
    x = "Date",
    y = "Win Rate"
  )
```

Trouble Brewing
==========

```{r tbsetup, include=FALSE}
tb_data <- data |> 
  filter(script == "Trouble Brewing")

tb_num_games <- tb_data |> 
  filter(result %in% c("Win", "Lose")) |> 
  nrow()

tb_num_wins <- tb_data |> 
  filter(result == "Win") |> 
  nrow()

tb_perc_wins <- (tb_num_wins/tb_num_games)*100
```

Row {data-height=200}
-----------------------------------------------------------------------

### Number of Trouble Brewing Games Played (Since 11/09/2023) 

```{r}
valueBox(tb_num_games)
```

### Trouble Brewing Win Percentage

```{r}
gauge(
  round(
    tb_perc_wins,
    digits = 2
  ),
  min = 0,
  max = 100,
  gaugeSectors(
    success = c(50, 100),
    warning = c(35, 50),
    danger = c(0, 35)
  ),
  symbol = "%"
)
```

Row {data-height=600}
-----------------------------------------------------------------------

### Trouble Brewing Alignment Distribution

```{r}
tb_data |> 
  mutate(
    starting_alignment = factor(starting_alignment, levels = alignments)
  ) |> 
  group_by(starting_alignment) |> 
  summarise(
    count = n()
  ) |> 
  ggplot() +
  aes(
    x = starting_alignment,
    y = count,
    fill = starting_alignment
  ) +
  geom_col(
    width = 0.6
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Starting Alignment",
    y = "Number of Games"
  ) +
  scale_fill_manual(
    drop = FALSE,  
    values = alignment_colours
  ) +
  guides(
    fill = "none"
  ) +
  scale_x_discrete(
    drop = FALSE
  )

```

### Trouble Brewing Alignment Win Rate

```{r}
tb_data |> 
  mutate(
    starting_alignment = factor(starting_alignment, levels = alignments)
  ) |> 
  filter(result %in% c("Win", "Lose")) |> 
  group_by(starting_alignment, result) |> 
  summarise(
    count = n()
  ) |> 
  ungroup() |> 
  group_by(starting_alignment) |> 
  pivot_wider(
    id_cols = starting_alignment,
    names_from = result,
    values_from = count
  ) %>%
  mutate(
    Lose = replace(Lose, is.na(Lose), 0),
    Win = replace(Win, is.na(Win), 0),
    win_perc = (Win / (Win + Lose)) * 100
  ) |> 
  ggplot() +
  aes(
    x = starting_alignment,
    y = win_perc,
    fill = starting_alignment
  ) +
  geom_col(
    width = 0.6
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Starting Alignment",
    y = "Win Percentage"
  ) +
  ylim(c(0, 100)) +
  scale_fill_manual(
    drop = FALSE,
    values = alignment_colours,
  ) +
  guides(
    fill = "none"
  ) +
  scale_x_discrete(
    drop = FALSE
  )
```

Row {data-height=600}
-----------------------------------------------------------------------

### Trouble Brewing Character Distribution

```{r}
tb_data |> 
  mutate(
    starting_character = factor(starting_character, levels = tb_characters) |>  fct_rev(),
    starting_alignment = factor(starting_alignment, levels = alignments)
  ) |> 
  group_by(starting_alignment, starting_character) |> 
  summarise(
    count = n()
  ) |> 
  ggplot() +
  aes(
    x = starting_character,
    y = count,
    fill = starting_alignment
  ) +
  geom_col(
    width = 0.9
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Starting Character",
    y = "Number of Games"
  ) +
  scale_fill_manual(
    drop = FALSE,
    values = alignment_colours
  ) +
  guides(
    fill = "none"
  ) +
  scale_x_discrete(
    drop = FALSE
  )

```

### Trouble Brewing Character Win Rate

```{r}
tb_data |> 
  mutate(
    starting_character = factor(starting_character, levels = tb_characters) |> fct_rev(),
    starting_alignment = factor(starting_alignment, levels = alignments)
  ) |> 
  filter(result %in% c("Win", "Lose")) |> 
  group_by(starting_alignment, starting_character, result) |> 
  summarise(
    count = n()
  ) |> 
  ungroup() |> 
  group_by(starting_alignment, starting_character) |> 
  pivot_wider(
    id_cols = c(starting_alignment, starting_character),
    names_from = result,
    values_from = count
  ) %>%
  mutate(
    Lose = replace(Lose, is.na(Lose), 0),
    Win = replace(Win, is.na(Win), 0),
    win_perc = (Win / (Win + Lose)) * 100
  ) |> 
  ggplot() +
  aes(
    x = starting_character,
    y = win_perc,
    fill = starting_alignment
  ) +
  geom_col(
    width = 0.9
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Starting Character",
    y = "Win Percentage"
  ) +
  ylim(c(0, 100)) +
  scale_fill_manual(
    drop = FALSE,
    values = alignment_colours,
  ) +
  guides(
    fill = "none"
  ) +
  scale_x_discrete(
    drop = FALSE
  )
```

Sects and Violets
==========

```{r snvsetup, include=FALSE}
snv_data <- data |> 
  filter(script == "Sects and Violets")

snv_num_games <- snv_data |> 
  filter(result %in% c("Win", "Lose")) |> 
  nrow()

snv_num_wins <- snv_data |> 
  filter(result == "Win") |> 
  nrow()

snv_perc_wins <- (snv_num_wins/snv_num_games)*100
```

Row {data-height=200}
-----------------------------------------------------------------------

### Number of Sects and Violets Games Played (Since 11/09/2023) 

```{r}
valueBox(snv_num_games)
```

### Sects and Violets Win Percentage

```{r}
gauge(
  round(
    snv_perc_wins,
    digits = 2
  ),
  min = 0,
  max = 100,
  gaugeSectors(
    success = c(50, 100),
    warning = c(35, 50),
    danger = c(0, 35)
  ),
  symbol = "%"
)
```

Row {data-height=600}
-----------------------------------------------------------------------

### Sects and Violets Alignment Distribution

```{r}
snv_data |> 
  mutate(
    starting_alignment = factor(starting_alignment, levels = alignments)
  ) |> 
  group_by(starting_alignment) |> 
  summarise(
    count = n()
  ) |> 
  ggplot() +
  aes(
    x = starting_alignment,
    y = count,
    fill = starting_alignment
  ) +
  geom_col(
    width = 0.6
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Starting Alignment",
    y = "Number of Games"
  ) +
  scale_fill_manual(
    drop = FALSE,
    values = alignment_colours
  ) +
  guides(
    fill = "none"
  ) + 
  scale_x_discrete(
    drop = FALSE
  )

```

### Sects and Violets Alignment Win Rate

```{r}
snv_data |> 
  mutate(
    starting_alignment = factor(starting_alignment, levels = alignments)
  ) |> 
  filter(result %in% c("Win", "Lose")) |> 
  group_by(starting_alignment, result) |> 
  summarise(
    count = n()
  ) |> 
  ungroup() |> 
  group_by(starting_alignment) |> 
  pivot_wider(
    id_cols = starting_alignment,
    names_from = result,
    values_from = count
  ) %>%
  mutate(
    Lose = replace(Lose, is.na(Lose), 0),
    Win = replace(Win, is.na(Win), 0),
    win_perc = (Win / (Win + Lose)) * 100
  ) |> 
  ggplot() +
  aes(
    x = starting_alignment,
    y = win_perc,
    fill = starting_alignment
  ) +
  geom_col(
    width = 0.6
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Starting Alignment",
    y = "Win Percentage"
  ) +
  ylim(c(0, 100)) +
  scale_fill_manual(
    drop = FALSE,
    values = alignment_colours,
  ) +
  guides(
    fill = "none"
  ) +
  scale_x_discrete(
    drop = FALSE
  )
```

Row {data-height=600}
-----------------------------------------------------------------------

### Sects and Violets Character Distribution

```{r}
snv_data |> 
  mutate(
    starting_character = factor(starting_character, levels = snv_characters) |>  fct_rev(),
    starting_alignment = factor(starting_alignment, levels = alignments)
  ) |> 
  group_by(starting_alignment, starting_character) |> 
  summarise(
    count = n()
  ) |> 
  ggplot() +
  aes(
    x = starting_character,
    y = count,
    fill = starting_alignment
  ) +
  geom_col(
    width = 0.9
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Starting Character",
    y = "Number of Games"
  ) +
  scale_fill_manual(
    drop = FALSE,
    values = alignment_colours
  ) +
  guides(
    fill = "none"
  ) +
  scale_x_discrete(
    drop = FALSE
  )

```

### Sects and Violets Character Win Rate

```{r}
snv_data |> 
  mutate(
    starting_character = factor(starting_character, levels = snv_characters) |> fct_rev(),
    starting_alignment = factor(starting_alignment, levels = alignments)
  ) |> 
  filter(result %in% c("Win", "Lose")) |> 
  group_by(starting_alignment, starting_character, result) |> 
  summarise(
    count = n()
  ) |> 
  ungroup() |> 
  group_by(starting_alignment, starting_character) |> 
  pivot_wider(
    id_cols = c(starting_alignment, starting_character),
    names_from = result,
    values_from = count
  ) %>%
  mutate(
    Lose = replace(Lose, is.na(Lose), 0),
    Win = replace(Win, is.na(Win), 0),
    win_perc = (Win / (Win + Lose)) * 100
  ) |> 
  ggplot() +
  aes(
    x = starting_character,
    y = win_perc,
    fill = starting_alignment
  ) +
  geom_col(
    width = 0.9
  ) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Starting Character",
    y = "Win Percentage"
  ) +
  ylim(c(0, 100)) +
  scale_fill_manual(
    drop = FALSE,
    values = alignment_colours,
  ) +
  guides(
    fill = "none"
  ) +
  scale_x_discrete(
    drop = FALSE
  )
```

Storytellers
==========

Row {data-height=200}
-----------------------------------------------------------------------

### Number of ST's who have run games I have played in

```{r}
num_st <- data$st[data$st != "Test"] |> unique() |> length()

valueBox(num_st)
```

Row
-----------------------------------------------------------------------

### My Most Common ST's

```{r}
data %>%
  filter(st != "Test") |> 
  group_by(st) |> 
  summarise(
    num_games = n(),
    num_wins = sum(result == "Win"),
    num_loss = sum(result == "Lose"),
    win_perc = num_wins / (num_wins + num_loss),
    win_perc = (win_perc * 100) |> round(digits = 2) |> as.character() |> paste0("%")
  ) |> 
  select(
    -num_wins,
    -num_loss
  ) |> 
  arrange(
    desc(num_games),
    desc(win_perc)
  ) |> 
  datatable(
    colnames = c("Storyteller", "Number of Games", "Win Percentage")
  )
```

### Comparing ST's

```{r}
library(ggrepel)

data %>%
  filter(st != "Test") |> 
  group_by(st) |> 
  summarise(
    num_games = n(),
    num_wins = sum(result == "Win"),
    num_loss = sum(result == "Lose"),
    win_perc = num_wins / (num_wins + num_loss)
  ) |> 
  select(
    -num_wins,
    -num_loss
  ) |> 
  arrange(
    desc(num_games),
    desc(win_perc)
  ) |> 
  ggplot() +
  aes(
    x = num_games,
    y = win_perc,
    label = st
  ) +
  geom_point() +
  geom_text_repel() +
  scale_y_continuous(
    limits = c(0, 1),
    labels = scales::percent_format()
  ) +
  scale_x_continuous(
    trans = scales::log10_trans()
  ) +
  theme_minimal() +
  labs(
    x = "Number of Games With The Storyteller",
    y = "Win Percentage With The Storyteller"
  )
```

Raw Sheet
==========

```{r}
datatable(
  data, 
  options = list(
    pageLength = 20
  ),
  colnames = c(
    "Date",
    "Script",
    "Starting\nCharacter",
    "Ending\nCharacter",
    "Starting\nAlignment",
    "Ending\nAlignment",
    "Result",
    "Number of\nCharacter Swaps",
    "Storyteller",
    "Notes"
  )
)
```